@page "/login"
@layout EmptyLayout
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@using System.Net.Http.Json

<div class="login-container">
    <div class="login-box">
        <h1>ğŸ”¹ğŸ”·ConXğŸ”·ğŸ”¹</h1>
        <h5>Windowsè¿œç¨‹æ§åˆ¶å°</h5>
        <h3>ğŸ” ç™»å½•</h3>
        <input @bind="_user" placeholder="ç”¨æˆ·å" />
        <input type="password" @bind="_pwd" placeholder="å¯†ç " />
        <div class="actions">
            <button @onclick="DoLogin" disabled="@_isSubmitting">@(_isSubmitting ? "æ­£åœ¨ç™»å½•..." : "ç™»å½•")</button>
            <button class="secondary" @onclick="OpenRegister" disabled="@_isSubmitting">æ³¨å†Œ</button>
        </div>
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="error">@_errorMessage</div>
        }
    </div>
</div>

@if (_showRegister)
{
    <div class="modal-backdrop">
        <div class="modal">
            <h4>æ³¨å†Œæ–°ç”¨æˆ·</h4>
            <input @bind="_registerUser" placeholder="ç”¨æˆ·å" />
            <input type="password" @bind="_registerPwd" placeholder="å¯†ç " />
            <input type="password" @bind="_registerPwdConfirm" placeholder="ç¡®è®¤å¯†ç " />
            @if (!string.IsNullOrEmpty(_registerError))
            {
                <div class="error">@_registerError</div>
            }
            <div class="actions">
                <button @onclick="ConfirmRegister">ç¡®è®¤</button>
                <button class="secondary" @onclick="CloseRegister">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
}

<style>
    .login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: radial-gradient(circle at 20% 20%, rgba(56,189,248,0.22), transparent 25%), 
                    radial-gradient(circle at 80% 0%, rgba(167,139,250,0.25), transparent 30%), 
                    linear-gradient(135deg, #0b1224 0%, #0f172a 55%, #111827 100%);
    }
    .actions { display:flex; gap:12px; margin-top:8px; }
    .secondary { background:#444; color:#fff; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.55); display:flex; align-items:center; justify-content:center; }
    .modal { background:#111827; padding:20px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.3); width:320px; display:flex; flex-direction:column; gap:10px; }
    .modal input { width:100%; }
</style>

@code{
    private string _user = string.Empty;
    private string _pwd = string.Empty;
    private bool _isSubmitting = false;
    private string _errorMessage = string.Empty;

    private bool _showRegister = false;
    private string _registerUser = string.Empty;
    private string _registerPwd = string.Empty;
    private string _registerPwdConfirm = string.Empty;
    private string _registerError = string.Empty;

    private async Task DoLogin()
    {
        if (_isSubmitting) return;
        _isSubmitting = true;
        _errorMessage = string.Empty;
        try
        {
            // Use browser fetch via JS runtime to ensure cookies set by SignInAsync are stored
            var result = await JS.InvokeAsync<System.Text.Json.JsonElement>("conx.login", "/api/auth/login", _user, _pwd);
            if (result.ValueKind == System.Text.Json.JsonValueKind.Object)
            {
                if (result.TryGetProperty("ok", out var okProp) && okProp.GetBoolean())
                {
                    Navigation.NavigateTo("/", true);
                }
                else if (result.TryGetProperty("status", out var statusProp) && statusProp.GetInt32() == 401)
                {
                    _errorMessage = "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯";
                }
                else
                {
                    _errorMessage = "ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
                }
            }
            else
            {
                _errorMessage = "ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "ç™»å½•æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚";
            Console.WriteLine(ex);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void OpenRegister()
    {
        _registerError = string.Empty;
        _showRegister = true;
    }

    private void CloseRegister()
    {
        _showRegister = false;
        _registerUser = _registerPwd = _registerPwdConfirm = string.Empty;
    }

    private async Task ConfirmRegister()
    {
        _registerError = string.Empty;
        if (string.IsNullOrWhiteSpace(_registerUser) || string.IsNullOrWhiteSpace(_registerPwd))
        {
            _registerError = "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º";
            return;
        }
        if (_registerPwd != _registerPwdConfirm)
        {
            _registerError = "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´";
            return;
        }

        try
        {
            var resp = await Http.PostAsJsonAsync("/api/auth/register", new RegisterRequest { UserName = _registerUser, Password = _registerPwd });
            if (resp.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                _registerError = "è¯¥ç”¨æˆ·åå·²æ³¨å†Œè¿‡";
                return;
            }
            if (!resp.IsSuccessStatusCode)
            {
                _registerError = "æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
                return;
            }

            // æ³¨å†ŒæˆåŠŸï¼Œå›åˆ°ç™»å½•ç•Œé¢å¹¶é¢„å¡«ç”¨æˆ·å
            _user = _registerUser;
            _pwd = string.Empty;
            _errorMessage = "æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•";
            CloseRegister();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            _registerError = "æ³¨å†Œæ—¶å‘ç”Ÿé”™è¯¯";
        }
    }

    private class RegisterRequest
    {
        public string UserName { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}
