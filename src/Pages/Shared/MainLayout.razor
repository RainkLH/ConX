@inherits LayoutComponentBase
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS
@attribute [Authorize]

<div class="main-layout">    
    <div class="sidebar">
        <nav>
            <ul style="list-style:none;padding:0;margin:0;">
                <li><NavLink href="/" Match="NavLinkMatch.All">ğŸ–¥ï¸ è¿›ç¨‹ç®¡ç†</NavLink></li>
                <li><NavLink href="/terminal" Match="NavLinkMatch.Prefix">âŒ¨ï¸ ç»ˆç«¯</NavLink></li>
            </ul>
        </nav>
    </div>
    <div class="content">  
        <div class="topbar">
            <div class="topbar__user">
                å½“å‰ç”¨æˆ·ï¼š@(_userName ?? "æœªç™»å½•")
            </div>
            <button class="btn__logout" @onclick="Logout">æ³¨é”€</button>
        </div>      
        @Body
    </div>
</div>


@code {
    [CascadingParameter] private Task<AuthenticationState> AuthStateTask { get; set; } = default!;
    private string? _userName;
    private bool _isLoggingOut = false;

    protected override async Task OnParametersSetAsync()
    {
        var authState = await AuthStateTask;
        _userName = authState.User.Identity?.IsAuthenticated == true
            ? authState.User.Identity.Name
            : "æœªç™»å½•";
    }

    private async Task Logout()
    {
        if (_isLoggingOut) return;
        _isLoggingOut = true;
        
        try 
        { 
            // ä½¿ç”¨ JavaScript è¾…åŠ©å‡½æ•°æ¥ç¡®ä¿å½»åº•æ¸…é™¤ Cookie
            await JS.InvokeVoidAsync("conx.logout", "/api/auth/logout");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Logout error: {ex.Message}");
        }
        finally
        {
            // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ç¡®ä¿ Cookie è¢«æ¸…é™¤ï¼Œç„¶ååˆ·æ–°é¡µé¢
            await Task.Delay(500);
            Nav.NavigateTo("/Login", forceLoad: true);
            _isLoggingOut = false;
        }
    }
}
